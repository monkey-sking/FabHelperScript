# Fab Helper 脚本架构设计

本文档介绍 Fab Helper 脚本的整体架构设计和核心模块。

## 整体架构

Fab Helper 脚本采用模块化设计，主要由以下几个核心模块组成：

```
+---------------------------+
|       脚本初始化          |
+---------------------------+
           |
           v
+---------------------------+
|       功能检测模块        |
+---------------------------+
           |
           v
+---------------------------+     +---------------------------+
|       限速处理模块        | <-> |       自动恢复模块        |
+---------------------------+     +---------------------------+
           |
           v
+---------------------------+     +---------------------------+
|       请求优化模块        | <-> |       游标恢复模块        |
+---------------------------+     +---------------------------+
           |
           v
+---------------------------+
|       DOM 观察模块        |
+---------------------------+
           |
           v
+---------------------------+     +---------------------------+
|       功能扩展模块        | <-> |       热更新模块          |
+---------------------------+     +---------------------------+
```

## 核心模块说明

### 1. 脚本初始化模块

负责脚本的初始化工作，包括：
- 设置全局变量和配置
- 注入CSS样式
- 初始化各个功能模块
- 添加事件监听器

### 2. 功能检测模块

检测当前页面环境和可用功能：
- 判断当前页面类型
- 检查API是否可用
- 检测浏览器环境
- 决定启用哪些功能

### 3. 限速处理模块

处理网站API请求限速问题：
- 检测 429 状态码（Too Many Requests）
- 记录限速发生时间和持续时间
- 监控全局 XHR 和 fetch 请求
- 触发自动恢复流程

关键函数：
```javascript
function handleRateLimit(source) {
  // 处理限速情况
}

function monitorXHRResponses() {
  // 监控XHR响应
}
```

### 4. 自动恢复模块

当检测到限速时自动尝试恢复：
- 计算适当的等待时间
- 管理自动刷新倒计时
- 执行页面刷新
- 恢复状态检测

关键函数：
```javascript
function startAutoRecovery() {
  // 启动自动恢复
}

function checkRecoveryStatus() {
  // 检查恢复状态
}
```

### 5. 请求优化模块

优化请求以避免触发限速：
- 实现请求去抖动（Debounce）
- 请求节流（Throttle）
- 请求队列管理
- 避免重复请求

关键函数：
```javascript
function debounceRequest(url, delay) {
  // 延迟请求发送
}

function throttleRequests() {
  // 限制请求频率
}
```

### 6. 游标恢复模块

记录和恢复浏览位置：
- 保存当前浏览游标
- 在页面刷新后恢复到原位置
- URL 修补和重定向
- 游标历史记录管理

关键函数：
```javascript
function saveCursorPosition(cursor) {
  // 保存当前游标位置
}

function restoreCursorPosition() {
  // 恢复游标位置
}
```

### 7. DOM 观察模块

监视页面 DOM 变化并作出响应：
- 使用 MutationObserver 监控页面变化
- 对特定元素进行增强
- 添加自定义 UI 元素
- 响应交互事件

关键函数：
```javascript
function setupDOMObserver() {
  // 设置 DOM 观察器
}

function handleDOMChange(mutations) {
  // 处理 DOM 变化
}
```

### 8. 功能扩展模块

实现各种辅助功能：
- 导出聊天记录
- 添加快捷操作
- 增强搜索功能
- 自定义界面优化

### 9. 热更新模块

实现脚本的自动更新：
- 检查新版本
- 下载更新
- 自动应用更新
- 更新日志显示

## 数据流

1. 用户浏览页面触发 API 请求
2. 请求优化模块处理请求（去抖动、节流）
3. 限速处理模块监控请求结果
4. 若检测到限速，自动恢复模块启动
5. 恢复后，游标恢复模块将页面恢复到原位置
6. DOM 观察模块持续监视页面变化并作出响应

## 扩展开发

开发新功能时，建议遵循以下步骤：

1. 创建独立的功能模块
2. 实现模块初始化函数
3. 在主脚本中导入并初始化该模块
4. 确保与现有模块正确交互
5. 添加适当的错误处理和日志记录

## 性能考量

- 使用防抖和节流技术避免过多请求
- 优化 DOM 操作，减少重排和重绘
- 合理使用缓存减少重复请求
- 异步处理耗时操作，避免阻塞主线程
- 使用局部变量而非全局变量
- 避免内存泄漏，特别是在事件监听和定时器中 