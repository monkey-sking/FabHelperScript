# Fab Helper 脚本项目规则 (Project Rules)

**版本: 1.0**

## 文档目的 (Purpose)

本文档是 Fab Helper 脚本核心逻辑和行为的“唯一事实来源”(Single Source of Truth)。所有未来的功能开发、代码修改和问题排查，都应严格遵守本文档中定义的规则。

---

### Rule #1: “已拥有”(Owned) 的判断标准 (The Golden Rule)

这是判断一个商品是否已属于用户的黄金法则，拥有最高优先级。

1.  **API 优先 (API First)**:
    *   **首选方式**: 必须优先通过请求 `https://www.fab.com/i/users/me/listings-states?listing_ids=<UID>` 这个 API 端点来判断所属权。如果返回的 JSON 数据中，对应 UID 的 `acquired` 字段为 `true`，则判定为**已拥有**。
    *   **适用场景**: 此方法适用于所有可以获取到商品 `UID` 的场景，尤其是在“侦察”(Recon) 和任务处理的初始阶段。

2.  **UI 备用方案 (UI Fallback)**:
    *   **触发条件**: 仅在 API 不可用或无法使用时，才可使用基于页面 UI 元素的判断。
    *   **权威结构**: 必须严格匹配以下 HTML 结构和文本内容 [[memory:3578490]]。同时满足以下两个条件才算**已拥有**:
        *   存在一个 `h2` 标签，其文本内容包含 `已保存在我的库中` 或 `Saved in My Library`。
        *   页面上存在一个按钮或链接，其文本内容包含 `在我的库中查看` 或 `View in My Library`。
    *   **排除项**: 任何其他文本，如“下载”(Download)、“在启动器中查看”等，都**不能**作为判断已拥有的依据。

---

### Rule #2: “可获取”(Acquirable) 的判断标准

这是判断一个标准免费商品是否可以被“添加”或“购买”的依据。

1.  **按钮文本**: 脚本应寻找包含以下**精确**文本的 `button` 元素：
    *   `添加到我的库`
    *   `Add to my library`

---

### Rule #3: “多许可项目”(Multi-License Item) 的处理流程

对于需要选择许可证才能获取的免费商品，必须遵循以下固定的自动化操作流程。

1.  **识别**: 寻找一个 `button` 元素，其文本内容包含 `选择许可` (Select License)。
2.  **打开选项**: 对该按钮执行 `deepClick` (模拟 mousedown/mouseup 事件)。
3.  **等待列表**: 等待 `div[role="listbox"]` 元素出现在 DOM 中。
4.  **定位免费选项**:
    *   在 `listbox` 内部，寻找一个包含**精确文本** `免费` (Free) 的 `span` 或 `div`。
    *   从该文本元素向上遍历 DOM，找到其最近的、`role="option"` 的父元素。这才是真正的可点击选项。
5.  **选择免费选项**: 对找到的 `role="option"` 元素执行 `deepClick`。
6.  **最终获取**: 在选择了许可证后，等待页面上出现符合 **Rule #2** 的“可获取”按钮，然后对其进行点击。

---

### Rule #4: 详情页面的标准操作序列 (Order of Operations)

在任何一个商品详情页（即 Worker Tab），脚本必须严格按照以下顺序执行操作：

1.  **API 所有权检查**: 首先执行 **Rule #1** 的 API 检查。如果已拥有，则任务成功，关闭页面。
2.  **UI 所有权检查 (备用)**: 如果 API 检查失败，则执行 **Rule #1** 的 UI 检查。如果已拥有，则任务成功，关闭页面。
3.  **多许可检查**: 检查页面是否符合 **Rule #3** 的多许可项目特征。如果符合，则执行 Rule #3 的流程。
4.  **标准获取**: 如果不是多许可项目，则寻找并点击符合 **Rule #2** 的获取按钮。
5.  **获取后验证**: 点击任何获取按钮后，脚本必须等待并重复执行 **Rule #1** 的检查，直到页面状态变为“已拥有”，才能判定任务成功。
6.  **失败处理**: 在以上任何一步骤中，如果发生超时或找不到目标元素等错误，则必须将该任务从“待办”(To-Do)列表移至“失败”(Failed)列表，并记录错误日志。**严禁**中断整个执行队列。

---

### Rule #5: “侦察”(Recon) 与“执行”(Execution) 的职责分离

脚本的两个核心模式必须严格分离。

1.  **侦察 (Recon)**:
    *   **唯一职责**: 批量发现**可能**是免费且未拥有的商品，并将它们作为任务（包含 `url` 和 `uid`）添加到“待办”(To-Do) 列表中。
    *   **操作**: 仅通过 API (`/i/listings/search`, `/i/users/me/listings-states`, `/i/listings/prices-infos`) 工作。
    *   **禁止行为**: 侦察进程**绝对不能**与页面 UI 交互，也**不能**尝试直接获取商品。

2.  **执行 (Execution)**:
    *   **唯一职责**: 从“待办”(To-Do) 列表中取出任务，打开新标签页（Worker Tab），并严格按照 **Rule #4** 的操作序列来完成任务。

---

### Rule #6: 网络优化 (Network Optimization)

为了提升脚本在 fab.com 上的 `performance`，脚本应默认启用 `resource blocking`，但仅针对 fab.com 域名下的图片、媒体和字体资源进行拦截。

- **拦截目标 (Blocking Targets)**:  
  仅拦截 `fab.com` 及其子域名（如 `www.fab.com`, `api.fab.com`）下的以下类型资源：  
  - 图片 (`image`)
  - 媒体 (`media`)
  - 字体 (`font`)

- **目的 (Purpose)**:  
  让 `worker tab` 加载更快，减少带宽和内存消耗，使自动化流程更 `lightweight`。

- **不影响 (No Side Effect)**:  
  不拦截其他网站的资源，保证浏览器正常访问其他网页时不受影响。 